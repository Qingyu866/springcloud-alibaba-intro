apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: ecommerce-alerts
  namespace: ecommerce
  labels:
    release: prometheus
    app: ecommerce
spec:
  groups:
  - name: ecommerce.rules
    interval: 30s
    rules:
    # 服务可用性告警
    - alert: ServiceDown
      expr: up{job="ecommerce/*"} == 0
      for: 1m
      labels:
        severity: critical
        team: platform
      annotations:
        summary: "服务实例下线 (instance {{ $labels.instance }})"
        description: "服务 {{ $labels.job }} 在实例 {{ $labels.instance }} 上已下线超过1分钟"

    # 高错误率告警
    - alert: HighErrorRate
      expr: |
        (
          sum(rate(http_server_requests_seconds_count{status=~"5..", namespace="ecommerce"}[5m])) by (service)
          /
          sum(rate(http_server_requests_seconds_count{namespace="ecommerce"}[5m])) by (service)
        ) > 0.05
      for: 5m
      labels:
        severity: warning
        team: backend
      annotations:
        summary: "服务 {{ $labels.service }} 错误率过高"
        description: "服务 {{ $labels.service }} 5分钟内错误率超过5%，当前值: {{ $value | humanizePercentage }}"

    # 高延迟告警
    - alert: HighLatency
      expr: |
        histogram_quantile(0.99,
          sum(rate(http_server_requests_seconds_bucket{namespace="ecommerce"}[5m])) by (service, le)
        ) > 1
      for: 10m
      labels:
        severity: warning
        team: backend
      annotations:
        summary: "服务 {{ $labels.service }} 延迟过高"
        description: "服务 {{ $labels.service }} P99延迟超过1秒，当前值: {{ $value }}s"

    # Pod 重启告警
    - alert: PodRestartingTooMuch
      expr: |
        increase(kube_pod_container_status_restarts_total{namespace="ecommerce"}[1h]) > 5
      for: 5m
      labels:
        severity: warning
        team: platform
      annotations:
        summary: "Pod {{ $labels.pod }} 频繁重启"
        description: "Pod {{ $labels.pod }} 在1小时内重启了 {{ $value }} 次"

    # CPU 使用率告警
    - alert: HighCPUUsage
      expr: |
        sum(rate(container_cpu_usage_seconds_total{namespace="ecommerce", container!=""}[5m])) by (pod)
        /
        sum(kube_pod_container_resource_limits{namespace="ecommerce", resource="cpu"}) by (pod)
        > 0.9
      for: 10m
      labels:
        severity: warning
        team: platform
      annotations:
        summary: "Pod {{ $labels.pod }} CPU使用率过高"
        description: "Pod {{ $labels.pod }} CPU使用率持续超过90%，当前值: {{ $value | humanizePercentage }}"

    # 内存使用率告警
    - alert: HighMemoryUsage
      expr: |
        sum(container_memory_working_set_bytes{namespace="ecommerce", container!=""}) by (pod)
        /
        sum(kube_pod_container_resource_limits{namespace="ecommerce", resource="memory"}) by (pod)
        > 0.9
      for: 10m
      labels:
        severity: warning
        team: platform
      annotations:
        summary: "Pod {{ $labels.pod }} 内存使用率过高"
        description: "Pod {{ $labels.pod }} 内存使用率持续超过90%，当前值: {{ $value | humanizePercentage }}"

    # 磁盘空间告警
    - alert: LowDiskSpace
      expr: |
        (
          node_filesystem_avail_bytes{mountpoint="/", namespace="ecommerce"}
          /
          node_filesystem_size_bytes{mountpoint="/", namespace="ecommerce"}
        ) < 0.1
      for: 5m
      labels:
        severity: warning
        team: platform
      annotations:
        summary: "节点 {{ $labels.instance }} 磁盘空间不足"
        description: "节点 {{ $labels.instance }} 根分区可用空间低于10%，当前值: {{ $value | humanizePercentage }}"

    # 数据库连接池告警
    - alert: DatabaseConnectionPoolHigh
      expr: |
        hikaricp_connections_active{namespace="ecommerce"}
        /
        hikaricp_connections_max{namespace="ecommerce"}
        > 0.9
      for: 5m
      labels:
        severity: warning
        team: backend
      annotations:
        summary: "服务 {{ $labels.service }} 数据库连接池使用率过高"
        description: "服务 {{ $labels.service }} 数据库连接池使用率超过90%，当前值: {{ $value | humanizePercentage }}"

    # Redis 连接异常告警
    - alert: RedisConnectionFailure
      expr: |
        sum(rate(redis_connection_exceptions_total{namespace="ecommerce"}[5m])) by (service) > 0
      for: 2m
      labels:
        severity: critical
        team: backend
      annotations:
        summary: "服务 {{ $labels.service }} Redis连接异常"
        description: "服务 {{ $labels.service }} 检测到Redis连接异常"

    # Nacos 健康检查告警
    - alert: NacosUnhealthy
      expr: |
        up{job="nacos", namespace="ecommerce"} == 0
      for: 2m
      labels:
        severity: critical
        team: platform
      annotations:
        summary: "Nacos 实例 {{ $labels.instance }} 不可用"
        description: "Nacos 实例 {{ $labels.instance }} 健康检查失败"

    # 订单处理速率告警
    - alert: LowOrderProcessingRate
      expr: |
        sum(rate(order_created_total{namespace="ecommerce"}[10m])) < 10
      for: 15m
      labels:
        severity: info
        team: business
      annotations:
        summary: "订单处理速率过低"
        description: "过去10分钟订单处理速率低于10单/秒，当前值: {{ $value }}"

    # 支付成功率告警
    - alert: LowPaymentSuccessRate
      expr: |
        (
          sum(rate(payment_success_total{namespace="ecommerce"}[10m]))
          /
          sum(rate(payment_total{namespace="ecommerce"}[10m]))
        ) < 0.95
      for: 10m
      labels:
        severity: warning
        team: business
      annotations:
        summary: "支付成功率过低"
        description: "过去10分钟支付成功率低于95%，当前值: {{ $value | humanizePercentage }}"

    # JVM 堆内存使用率告警
    - alert: HighHeapMemoryUsage
      expr: |
        jvm_memory_used_bytes{area="heap", namespace="ecommerce"}
        /
        jvm_memory_max_bytes{area="heap", namespace="ecommerce"}
        > 0.9
      for: 5m
      labels:
        severity: warning
        team: backend
      annotations:
        summary: "服务 {{ $labels.service }} 堆内存使用率过高"
        description: "服务 {{ $labels.service }} 堆内存使用率超过90%，可能导致GC频繁"

    # GC 时间过长告警
    - alert: LongGCPause
      expr: |
        rate(jvm_gc_pause_seconds_sum{namespace="ecommerce"}[5m])
        /
        rate(jvm_gc_pause_seconds_count{namespace="ecommerce"}[5m])
        > 1
      for: 10m
      labels:
        severity: warning
        team: backend
      annotations:
        summary: "服务 {{ $labels.service }} GC暂停时间过长"
        description: "服务 {{ $labels.service }} 平均GC暂停时间超过1秒，当前值: {{ $value }}s"
