# MySQL 配置文件
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-config
  namespace: springcloud-alibaba
  labels:
    app: mysql
data:
  master.cnf: |
    [mysqld]
    log-bin=mysql-bin
    binlog_format=ROW
    server-id=1
    gtid-mode=ON
    enforce-gtid-consistency=ON
    log-slave-updates=ON
    max_connections=1000
    max_allowed_packet=256M
    innodb_buffer_pool_size=1G
    innodb_log_file_size=256M
    innodb_flush_log_at_trx_commit=2
    sync_binlog=1
    slow_query_log=ON
    long_query_time=2
    character-set-server=utf8mb4
    collation-server=utf8mb4_unicode_ci

  slave.cnf: |
    [mysqld]
    server-id=2
    relay-log=relay-bin
    read-only=1
    gtid-mode=ON
    enforce-gtid-consistency=ON
    log-slave-updates=ON
    max_connections=1000
    max_allowed_packet=256M
    innodb_buffer_pool_size=1G
    innodb_log_file_size=256M
    character-set-server=utf8mb4
    collation-server=utf8mb4_unicode_ci

  init-sql.sql: |
    -- 初始化数据库
    CREATE DATABASE IF NOT EXISTS nacos_config DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
    CREATE DATABASE IF NOT EXISTS springcloud_alibaba DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
    CREATE DATABASE IF NOT EXISTS seata DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

    -- 创建用户
    CREATE USER IF NOT EXISTS 'nacos'@'%' IDENTIFIED BY 'nacos@2024';
    CREATE USER IF NOT EXISTS 'app'@'%' IDENTIFIED BY 'app@2024';
    CREATE USER IF NOT EXISTS 'seata'@'%' IDENTIFIED BY 'seata@2024';

    -- 授权
    GRANT ALL PRIVILEGES ON nacos_config.* TO 'nacos'@'%';
    GRANT ALL PRIVILEGES ON springcloud_alibaba.* TO 'app'@'%';
    GRANT ALL PRIVILEGES ON seata.* TO 'seata'@'%';
    FLUSH PRIVILEGES;
