# Spring Cloud Alibaba ç»¼åˆé¡¹ç›® - GitLab CI/CD æµæ°´çº¿
# æ”¯æŒå¾®æœåŠ¡æ¶æ„ã€è‡ªåŠ¨åŒ–æµ‹è¯•ã€å®‰å…¨æ‰«æã€å¤šç¯å¢ƒéƒ¨ç½²

stages:
  - build
  - test
  - security
  - package
  - deploy-staging
  - integration-test
  - deploy-production

variables:
  # Maven é…ç½®
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"

  # Docker é…ç½®
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

  # Kubernetes é…ç½®
  KUBECONFIG: /root/.kube/config
  K8S_NAMESPACE: springcloud-alibaba

  # é•œåƒæ ‡ç­¾
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA
  IMAGE_LATEST: $CI_COMMIT_REF_SLUG

  # é•œåƒä»“åº“
  REGISTRY: registry.example.com
  IMAGE_PREFIX: springcloud-alibaba

# ç¼“å­˜ Maven ä¾èµ–
.cache_maven: &cache_maven
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .m2/repository/
      - target/

# å®šä¹‰æ‰€æœ‰æœåŠ¡
.services: &services
  - gateway
  - order-service
  - user-service
  - payment-service
  - flash-order-service
  - inventory-service
  - callback-service
  - auth-service
  - permission-service
  - tenant-service
  - profile-service
  - reconciliation-service

# ==================== æ„å»ºé˜¶æ®µ ====================

# ç¼–è¯‘æ‰€æœ‰æœåŠ¡
build:
  stage: build
  image: maven:3.9-eclipse-temurin-17-alpine
  <<: *cache_maven
  script:
    - echo "ğŸ”¨ ç¼–è¯‘ Spring Cloud Alibaba é¡¹ç›®..."
    - mvn $MAVEN_CLI_OPTS clean compile -DskipTests
    - echo "âœ… ç¼–è¯‘å®Œæˆ"
  artifacts:
    paths:
      - target/
    expire_in: 1 hour
  only:
    - main
    - develop
    - /^feature\/.*$/

# ==================== æµ‹è¯•é˜¶æ®µ ====================

# å•å…ƒæµ‹è¯•
unit-test:
  stage: test
  image: maven:3.9-eclipse-temurin-17-alpine
  <<: *cache_maven
  dependencies:
    - build
  script:
    - echo "ğŸ§ª æ‰§è¡Œå•å…ƒæµ‹è¯•..."
    - mvn $MAVEN_CLI_OPTS test
    - echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
    reports:
      junit: "**/target/surefire-reports/TEST-*.xml"
      coverage_report:
        coverage_format: cobertura
        path: "**/target/site/jacoco/jacoco.xml"
    paths:
      - target/site/jacoco/
    expire_in: 1 week
  only:
    - main
    - develop
    - /^feature\/.*$/

# é›†æˆæµ‹è¯•
integration-test:
  stage: test
  image: maven:3.9-eclipse-temurin-17-alpine
  <<: *cache_maven
  services:
    - name: mysql:8.0
      alias: mysql
      variables:
        MYSQL_ROOT_PASSWORD: Root@123456
        MYSQL_DATABASE: springcloud_alibaba
    - name: redis:7.2-alpine
      alias: redis
    - name: apache/rocketmq:5.3.0
      alias: rocketmq
      command: ["mqnamesrv"]
  variables:
    SPRING_DATASOURCE_URL: "jdbc:mysql://mysql:3306/springcloud_alibaba?useSSL=false"
    SPRING_DATASOURCE_USERNAME: root
    SPRING_DATASOURCE_PASSWORD: Root@123456
    SPRING_REDIS_HOST: redis
    SPRING_REDIS_PORT: 6379
    ROCKETMQ_NAME_SERVER: rocketmq:9876
  dependencies:
    - build
  script:
    - echo "ğŸ”— æ‰§è¡Œé›†æˆæµ‹è¯•..."
    - mvn $MAVEN_CLI_OPTS verify -DskipUnitTests -Dspring.profiles.active=test
    - echo "âœ… é›†æˆæµ‹è¯•é€šè¿‡"
  artifacts:
    reports:
      junit: "**/target/failsafe-reports/TEST-*.xml"
  only:
    - main
    - develop

# ==================== å®‰å…¨æ‰«æé˜¶æ®µ ====================

# OWASP ä¾èµ–æ£€æŸ¥
security-scan:
  stage: security
  image: maven:3.9-eclipse-temurin-17-alpine
  <<: *cache_maven
  dependencies:
    - build
  script:
    - echo "ğŸ”’ æ‰§è¡Œå®‰å…¨æ‰«æ..."
    - mvn org.owasp:dependency-check-maven:check
    - echo "âœ… å®‰å…¨æ‰«æå®Œæˆ"
  artifacts:
    paths:
      - target/dependency-check-report.html
    expire_in: 1 week
  allow_failure: true
  only:
    - main
    - develop

# å®¹å™¨é•œåƒæ‰«æ (Trivy)
container-scan:
  stage: security
  image: aquasec/trivy:latest
  dependencies:
    - package-gateway
  script:
    - echo "ğŸ”’ æ‰«æå®¹å™¨é•œåƒæ¼æ´..."
    - trivy image --exit-code 0 --severity HIGH,CRITICAL $REGISTRY/$IMAGE_PREFIX/gateway:$IMAGE_TAG
    - echo "âœ… é•œåƒæ‰«æå®Œæˆ"
  allow_failure: true
  only:
    - main
    - develop

# ==================== é•œåƒæ„å»ºé˜¶æ®µ ====================

# ä¸ºæ‰€æœ‰æœåŠ¡æ„å»ºå¹¶æ¨é€é•œåƒ
.package-template: &package_template
  stage: package
  image: docker:24.0-dind
  services:
    - docker:24.0-dind
  dependencies:
    - build
    - unit-test
  before_script:
    - echo "$REGISTRY_PASSWORD" | docker login -u "$REGISTRY_USER" --password-stdin $REGISTRY
  script:
    - echo "ğŸ“¦ æ„å»º $SERVICE é•œåƒ..."
    - cd $SERVICE
    - docker build -t $REGISTRY/$IMAGE_PREFIX/$SERVICE:$IMAGE_TAG .
    - docker tag $REGISTRY/$IMAGE_PREFIX/$SERVICE:$IMAGE_TAG $REGISTRY/$IMAGE_PREFIX/$SERVICE:$IMAGE_LATEST
    - docker push $REGISTRY/$IMAGE_PREFIX/$SERVICE:$IMAGE_TAG
    - docker push $REGISTRY/$IMAGE_PREFIX/$SERVICE:$IMAGE_LATEST
    - echo "âœ… $SERVICE é•œåƒæ¨é€å®Œæˆ"
  only:
    - main
    - develop

package-gateway:
  <<: *package_template
  variables:
    SERVICE: gateway

package-order-service:
  <<: *package_template
  variables:
    SERVICE: order-service

package-user-service:
  <<: *package_template
  variables:
    SERVICE: user-service

package-flash-order-service:
  <<: *package_template
  variables:
    SERVICE: flash-order-service

package-inventory-service:
  <<: *package_template
  variables:
    SERVICE: inventory-service

package-payment-service:
  <<: *package_template
  variables:
    SERVICE: payment-service

package-callback-service:
  <<: *package_template
  variables:
    SERVICE: callback-service

package-auth-service:
  <<: *package_template
  variables:
    SERVICE: auth-service

package-permission-service:
  <<: *package_template
  variables:
    SERVICE: permission-service

package-tenant-service:
  <<: *package_template
  variables:
    SERVICE: tenant-service

package-profile-service:
  <<: *package_template
  variables:
    SERVICE: profile-service

package-reconciliation-service:
  <<: *package_template
  variables:
    SERVICE: reconciliation-service

# ==================== éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ ====================

deploy-staging:
  stage: deploy-staging
  image: bitnami/kubectl:latest
  dependencies:
    - package-gateway
    - package-order-service
    - package-user-service
    - package-flash-order-service
    - package-inventory-service
    - package-payment-service
    - package-callback-service
    - package-auth-service
    - package-permission-service
    - package-tenant-service
    - package-profile-service
    - package-reconciliation-service
  script:
    - echo "ğŸš€ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."
    - kubectl config use-context staging
    # æ›´æ–°æ‰€æœ‰æœåŠ¡é•œåƒ
    - |
      for SERVICE in gateway order-service user-service flash-order-service inventory-service payment-service callback-service auth-service permission-service tenant-service profile-service; do
        kubectl set image deployment/$SERVICE $SERVICE=$REGISTRY/$IMAGE_PREFIX/$SERVICE:$IMAGE_TAG -n $K8S_NAMESPACE-staging
        kubectl rollout status deployment/$SERVICE -n $K8S_NAMESPACE-staging --timeout=300s
      done
    - echo "âœ… æµ‹è¯•ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
  environment:
    name: staging
    url: https://staging.example.com
  only:
    - develop

# ==================== é›†æˆæµ‹è¯• ====================

integration-test-staging:
  stage: integration-test
  image: curlimages/curl:latest
  dependencies:
    - deploy-staging
  script:
    - echo "ğŸ”— æ‰§è¡Œç¯å¢ƒé›†æˆæµ‹è¯•..."
    # å¥åº·æ£€æŸ¥
    - curl -f https://staging.example.com/actuator/health || exit 1
    # API æ¥å£æµ‹è¯•
    - curl -f https://staging.example.com/api/user/info || exit 1
    - curl -f https://staging.example.com/api/order/list || exit 1
    - echo "âœ… é›†æˆæµ‹è¯•é€šè¿‡"
  only:
    - develop

# ==================== éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ ====================

deploy-production:
  stage: deploy-production
  image: bitnami/kubectl:latest
  dependencies:
    - package-gateway
    - package-order-service
    - package-user-service
    - package-flash-order-service
    - package-inventory-service
    - package-payment-service
    - package-callback-service
    - package-auth-service
    - package-permission-service
    - package-tenant-service
    - package-profile-service
    - package-reconciliation-service
  script:
    - echo "ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
    - kubectl config use-context production

    # ç­–ç•¥ï¼šé‡‘ä¸é›€éƒ¨ç½²
    # 1. å…ˆéƒ¨ç½²ç§’æ€æœåŠ¡ï¼ˆå¿«é€Ÿæ‰©å®¹èƒ½åŠ›ï¼‰
    - kubectl set image deployment/flash-order-service flash-order-service=$REGISTRY/$IMAGE_PREFIX/flash-order-service:$IMAGE_TAG -n $K8S_NAMESPACE
    - kubectl rollout status deployment/flash-order-service -n $K8S_NAMESPACE --timeout=300s
    - echo "â±ï¸  ç§’æ€æœåŠ¡é‡‘ä¸é›€è§‚å¯ŸæœŸï¼ˆ2åˆ†é’Ÿï¼‰..."
    - sleep 120

    # 2. éƒ¨ç½²ç½‘å…³
    - kubectl set image deployment/gateway gateway=$REGISTRY/$IMAGE_PREFIX/gateway:$IMAGE_TAG -n $K8S_NAMESPACE
    - kubectl rollout status deployment/gateway -n $K8S_NAMESPACE --timeout=300s

    # 3. éƒ¨ç½²æ ¸å¿ƒæœåŠ¡
    - |
      for SERVICE in order-service user-service inventory-service payment-service; do
        kubectl set image deployment/$SERVICE $SERVICE=$REGISTRY/$IMAGE_PREFIX/$SERVICE:$IMAGE_TAG -n $K8S_NAMESPACE
        kubectl rollout status deployment/$SERVICE -n $K8S_NAMESPACE --timeout=300s
      done

    # 4. éƒ¨ç½²å…¶ä»–æœåŠ¡
    - |
      for SERVICE in callback-service auth-service permission-service tenant-service profile-service; do
        kubectl set image deployment/$SERVICE $SERVICE=$REGISTRY/$IMAGE_PREFIX/$SERVICE:$IMAGE_TAG -n $K8S_NAMESPACE
        kubectl rollout status deployment/$SERVICE -n $K8S_NAMESPACE --timeout=300s
      done

    - echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
  environment:
    name: production
    url: https://api.example.com
  when: manual
  only:
    - main

# ==================== å›æ»šä»»åŠ¡ ====================

rollback-production:
  stage: deploy-production
  image: bitnami/kubectl:latest
  script:
    - echo "âª å›æ»šç”Ÿäº§ç¯å¢ƒ..."
    - kubectl config use-context production
    - |
      for SERVICE in gateway order-service user-service flash-order-service inventory-service payment-service callback-service auth-service permission-service tenant-service profile-service; do
        kubectl rollout undo deployment/$SERVICE -n $K8S_NAMESPACE
      done
    - echo "âœ… å›æ»šå®Œæˆ"
  environment:
    name: production
    action: stop
  when: manual
  only:
    - main
