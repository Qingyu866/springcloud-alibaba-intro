apiVersion: v1
kind: ConfigMap
metadata:
  name: seata-config
  namespace: payment
data:
  file.conf: |
    transport {
      # TCP, UNIX_DOMAIN_SOCKET
      type = "TCP"
      #NIO, NATIVE
      server = "NIO"
      #heartbeat
      heartbeat = true
      #thread factory for netty
      thread-factory {
        boss-thread-prefix = "NettyBoss"
        worker-thread-prefix = "NettyServerNIOWorker"
        server-executor-thread-prefix = "NettyServerBizHandler"
        share-boss-worker = false
        client-selector-thread-prefix = "NettyClientSelectorThread"
        client-selector-thread-size = 1
        client-worker-thread-prefix = "NettyClientWorkerThread"
        # netty boss thread size
        boss-thread-size = 1
        #auto default worker thread size
        worker-thread-size = 8
      }
      shutdown {
        # when destroy server, wait seconds
        wait = 3
      }
      serialization = "seata"
      compressor = "none"
    }
    service {
      #vgroup->rgroup
      vgroup_mapping.payment-tx-group = "default"
      #only support single node
      default.grouplist = "seata-0.seata.payment.svc.cluster.local:8091"
      #degrade current not support
      enableDegrade = false
      #disable
      disable = false
      #unit ms,s,m,h,d,default ms
      max.commit.retry.timeout = "-1"
      max.rollback.retry.timeout = "-1"
    }
    client {
      async.commit.buffer.limit = 10000
      lock {
        retry.internal = 10
        retry.times = 30
      }
      report.retry.count = 5
      tm.commit.retry.count = 1
      tm.rollback.retry.count = 1
    }
    store {
      # branch session size
      mode = "db"
      db {
        ## the implement of javax.sql.DataSource.
        ## datasource class
        datasource = "druid"
        ## mysql/oracle/h2/oceanbase etc.
        db-type = "mysql"
        driver-class-name = "com.mysql.jdbc.Driver"
        url = "jdbc:mysql://mysql.payment.svc.cluster.local:3306/seata?useSSL=false&serverTimezone=Asia/Shanghai"
        user = "root"
        password = "${MYSQL_ROOT_PASSWORD}"
        min-conn = 1
        max-conn = 10
        global.table = "global_table"
        branch.table = "branch_table"
        lock-table = "lock_table"
        query-limit = 100
      }
    }
  registry.conf: |
    registry {
      # file、nacos、eureka、redis、zk、consul、etcd3、sofa
      type = "nacos"

      nacos {
        application = "seata-server"
        serverAddr = "nacos.payment.svc.cluster.local:8848"
        group = "SEATA_GROUP"
        namespace = "payment"
        cluster = "default"
        username = ""
        password = ""
      }
    }
    config {
      # file、nacos、apollo、zk、consul、etcd3
      type = "nacos"

      nacos {
        serverAddr = "nacos.payment.svc.cluster.local:8848"
        namespace = "payment"
        group = "SEATA_GROUP"
        username = ""
        password = ""
      }
    }

---
apiVersion: v1
kind: Secret
metadata:
  name: seata-secret
  namespace: payment
type: Opaque
data:
  mysql-password: cm9vdF9wYXNzd29yZA==

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: seata
  namespace: payment
  labels:
    app: seata
spec:
  serviceName: seata
  replicas: 1
  selector:
    matchLabels:
      app: seata
  template:
    metadata:
      labels:
        app: seata
    spec:
      # 初始化容器：等待 MySQL 和 Nacos
      initContainers:
      - name: wait-mysql
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          until nc -z -v -w30 mysql.payment.svc.cluster.local 3306
          do
            echo "Waiting for MySQL..."
            sleep 5
          done
      - name: wait-nacos
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          until nc -z -v -w30 nacos.payment.svc.cluster.local 8848
          do
            echo "Waiting for Nacos..."
            sleep 5
          done
      containers:
      - name: seata
        image: seataio/seata-server:2.0.0
        ports:
        - containerPort: 8091
          name: server
        env:
        - name: SEATA_PORT
          value: "8091"
        - name: STORE_MODE
          value: "db"
        - name: SEATA_CONFIG_NAME
          value: "file:/root/seata-config/file.conf"
        - name: SEATA_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: seata-secret
              key: mysql-password
        volumeMounts:
        - name: config
          mountPath: /root/seata-config
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /
            port: 8091
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /
            port: 8091
          initialDelaySeconds: 40
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
      volumes:
      - name: config
        configMap:
          name: seata-config

---
apiVersion: v1
kind: Service
metadata:
  name: seata
  namespace: payment
  labels:
    app: seata
spec:
  ports:
  - port: 8091
    targetPort: 8091
    name: server
  clusterIP: None
  selector:
    app: seata
