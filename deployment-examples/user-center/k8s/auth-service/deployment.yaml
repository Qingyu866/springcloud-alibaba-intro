---
apiVersion: v1
kind: ConfigMap
metadata:
  name: auth-config
  namespace: user-center
data:
  application.yml: |
    server:
      port: 8086
      servlet:
        context-path: /auth

    spring:
      application:
        name: auth-service
      datasource:
        url: jdbc:mysql://mysql.user-center.svc.cluster.local:3306/user_center?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
        username: usercenter
        password: ${MYSQL_PASSWORD}
        driver-class-name: com.mysql.cj.jdbc.Driver
        hikari:
          maximum-pool-size: 50
          minimum-idle: 10
          connection-timeout: 30000
          idle-timeout: 600000
          max-lifetime: 1800000
      data:
        redis:
          host: redis.user-center.svc.cluster.local
          port: 6379
          password: ${REDIS_PASSWORD}
          database: 1
          lettuce:
            pool:
              max-active: 50
              max-idle: 20
              min-idle: 5
              max-wait: 1000ms
      cloud:
        nacos:
          discovery:
            server-addr: nacos:8848
            namespace: user-center
            group: USER_CENTER_GROUP

    management:
      endpoints:
        web:
          exposure:
            include: health,info,prometheus,metrics
          base-path: /actuator
      metrics:
        export:
          prometheus:
            enabled: true
        tags:
          application: ${spring.application.name}
          environment: production

    auth:
      jwt:
        secret: ${JWT_SECRET}
        expiration: 7200  # 2小时
        refresh-expiration: 604800  # 7天
        issuer: user-center-auth
      oauth2:
        enabled: true
        providers:
          github:
            client-id: ${GITHUB_CLIENT_ID}
            client-secret: ${GITHUB_CLIENT_SECRET}
          wechat:
            app-id: ${WECHAT_APP_ID}
            app-secret: ${WECHAT_APP_SECRET}
          dingtalk:
            app-id: ${DINGTALK_APP_ID}
            app-secret: ${DINGTALK_APP_SECRET}
      sso:
        enabled: true
        cookie-domain: .example.com
        session-cache-ttl: 3600
        allowed-origins:
          - https://app.example.com
          - https://admin.example.com
      security:
        password-min-length: 8
        password-require-uppercase: true
        password-require-number: true
        max-login-attempts: 5
        lockout-duration: 1800  # 30分钟
        captcha-enabled: true
        captcha-provider: google  # google/aliyun
      token-blacklist:
        enabled: true
        cache-prefix: "auth:blacklist:"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
  namespace: user-center
  labels:
    app: auth-service
    component: service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: auth-service
  template:
    metadata:
      labels:
        app: auth-service
        component: service
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8086"
        prometheus.io/path: "/auth/actuator/prometheus"
    spec:
      containers:
      - name: auth-service
        image: your-registry/user-center/auth-service:latest
        ports:
        - name: http
          containerPort: 8086
          protocol: TCP
        - name: management
          containerPort: 8087
          protocol: TCP
        env:
        - name: JAVA_OPTS
          value: "-Xms1g -Xmx2g -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
        - name: MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: user-password
        - name: REDIS_PASSWORD
          value: "redis_password_change_me"
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: jwt-secret
              key: secret
        - name: GITHUB_CLIENT_ID
          value: "your_github_client_id"
        - name: GITHUB_CLIENT_SECRET
          value: "your_github_client_secret"
        - name: WECHAT_APP_ID
          value: "your_wechat_app_id"
        - name: WECHAT_APP_SECRET
          value: "your_wechat_app_secret"
        - name: TZ
          value: Asia/Shanghai
        volumeMounts:
        - name: auth-config
          mountPath: /config
        livenessProbe:
          httpGet:
            path: /auth/actuator/health
            port: 8087
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /auth/actuator/health
            port: 8087
          initialDelaySeconds: 30
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
      volumes:
      - name: auth-config
        configMap:
          name: auth-config
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - auth-service
              topologyKey: kubernetes.io/hostname

---
apiVersion: v1
kind: Service
metadata:
  name: auth-service
  namespace: user-center
  labels:
    app: auth-service
    component: service
spec:
  type: ClusterIP
  ports:
  - port: 8086
    targetPort: 8086
    protocol: TCP
    name: http
  selector:
    app: auth-service

---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: auth-service-hpa
  namespace: user-center
  labels:
    app: auth-service
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: auth-service
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 30
      - type: Pods
        value: 2
        periodSeconds: 30
      selectPolicy: Max
