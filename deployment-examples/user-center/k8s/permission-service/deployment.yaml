---
apiVersion: v1
kind: ConfigMap
metadata:
  name: permission-config
  namespace: user-center
data:
  application.yml: |
    server:
      port: 8088
      servlet:
        context-path: /permission

    spring:
      application:
        name: permission-service
      datasource:
        url: jdbc:mysql://mysql.user-center.svc.cluster.local:3306/user_center?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
        username: usercenter
        password: ${MYSQL_PASSWORD}
        driver-class-name: com.mysql.cj.jdbc.Driver
        hikari:
          maximum-pool-size: 50
          minimum-idle: 10
          connection-timeout: 30000
          idle-timeout: 600000
          max-lifetime: 1800000
      data:
        redis:
          host: redis.user-center.svc.cluster.local
          port: 6379
          password: ${REDIS_PASSWORD}
          database: 2
          lettuce:
            pool:
              max-active: 50
              max-idle: 20
              min-idle: 5
              max-wait: 1000ms
      cloud:
        nacos:
          discovery:
            server-addr: nacos:8848
            namespace: user-center
            group: USER_CENTER_GROUP

    management:
      endpoints:
        web:
          exposure:
            include: health,info,prometheus,metrics
          base-path: /actuator
      metrics:
        export:
          prometheus:
            enabled: true
        tags:
          application: ${spring.application.name}
          environment: production

    permission:
      rbac:
        enabled: true
        cache-enabled: true
        cache-ttl: 300
        super-admin-role: SUPER_ADMIN
        data-permission:
          enabled: true
          strategy: tenant  # tenant/organization/custom
      casbin:
        enabled: false
        model-path: /config/casbin_model.conf
        policy-loader: database  # database/file

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: permission-service
  namespace: user-center
  labels:
    app: permission-service
    component: service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: permission-service
  template:
    metadata:
      labels:
        app: permission-service
        component: service
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8088"
        prometheus.io/path: "/permission/actuator/prometheus"
    spec:
      containers:
      - name: permission-service
        image: your-registry/user-center/permission-service:latest
        ports:
        - name: http
          containerPort: 8088
          protocol: TCP
        - name: management
          containerPort: 8089
          protocol: TCP
        env:
        - name: JAVA_OPTS
          value: "-Xms1g -Xmx2g -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
        - name: MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: user-password
        - name: REDIS_PASSWORD
          value: "redis_password_change_me"
        - name: TZ
          value: Asia/Shanghai
        volumeMounts:
        - name: permission-config
          mountPath: /config
        livenessProbe:
          httpGet:
            path: /permission/actuator/health
            port: 8089
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /permission/actuator/health
            port: 8089
          initialDelaySeconds: 30
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
      volumes:
      - name: permission-config
        configMap:
          name: permission-config
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - permission-service
              topologyKey: kubernetes.io/hostname

---
apiVersion: v1
kind: Service
metadata:
  name: permission-service
  namespace: user-center
  labels:
    app: permission-service
    component: service
spec:
  type: ClusterIP
  ports:
  - port: 8088
    targetPort: 8088
    protocol: TCP
    name: http
  selector:
    app: permission-service

---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: permission-service-hpa
  namespace: user-center
  labels:
    app: permission-service
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: permission-service
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 30
      - type: Pods
        value: 2
        periodSeconds: 30
      selectPolicy: Max
