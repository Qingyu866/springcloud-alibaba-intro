# ç§’æ€ç³»ç»Ÿ - GitLab CI/CD æµæ°´çº¿é…ç½®
# é’ˆå¯¹ Redis é¢„å‡åº“å­˜ + RocketMQ å¼‚æ­¥ä¸‹å•çš„é«˜å¹¶å‘åœºæ™¯ä¼˜åŒ–

stages:
  - build
  - test
  - security
  - package
  - deploy-staging
  - smoke-test
  - deploy-production

variables:
  # Maven é…ç½®
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  # Docker é…ç½®
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  # Kubernetes é…ç½®
  KUBECONFIG: /root/.kube/config
  # é•œåƒæ ‡ç­¾
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA
  IMAGE_LATEST: $CI_COMMIT_BRANCH

# ç¼“å­˜ Maven ä¾èµ–
.cache_maven: &cache_maven
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .m2/repository/
      - target/

# æ„å»ºé˜¶æ®µ
build:
  stage: build
  image: maven:3.9-eclipse-temurin-17-alpine
  <<: *cache_maven
  script:
    - echo "ğŸ”¨ ç¼–è¯‘ç§’æ€ç³»ç»Ÿä»£ç ..."
    - mvn $MAVEN_CLI_OPTS clean compile -DskipTests
    - echo "âœ… ç¼–è¯‘å®Œæˆ"
  artifacts:
    paths:
      - target/
    expire_in: 1 hour
  only:
    - main
    - develop
    - /^feature\/.*$/

# å•å…ƒæµ‹è¯•
unit-test:
  stage: test
  image: maven:3.9-eclipse-temurin-17-alpine
  <<: *cache_maven
  dependencies:
    - build
  script:
    - echo "ğŸ§ª æ‰§è¡Œå•å…ƒæµ‹è¯•..."
    - mvn $MAVEN_CLI_OPTS test
    - echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
    reports:
      junit: "**/target/surefire-reports/TEST-*.xml"
      coverage_report:
        coverage_format: cobertura
        path: "**/target/site/jacoco/jacoco.xml"
    paths:
      - target/site/jacoco/
    expire_in: 1 week
  only:
    - main
    - develop
    - /^feature\/.*$/

# é›†æˆæµ‹è¯•ï¼ˆRedis + RocketMQï¼‰
integration-test:
  stage: test
  image: maven:3.9-eclipse-temurin-17-alpine
  <<: *cache_maven
  services:
    - name: redis:7.2-alpine
      alias: redis
    - name: apache/rocketmq:5.3.0
      alias: rocketmq
      command: ["mqnamesrv"]
  variables:
    REDIS_HOST: redis
    REDIS_PORT: 6379
    ROCKETMQ_NAME_SERVER: rocketmq:9876
  dependencies:
    - build
  script:
    - echo "ğŸ”— æ‰§è¡Œé›†æˆæµ‹è¯•ï¼ˆRedis é¢„å‡åº“å­˜ + RocketMQ å¼‚æ­¥ä¸‹å•ï¼‰..."
    - mvn $MAVEN_CLI_OPTS verify -DskipUnitTests -Dspring.profiles.active=test
    - echo "âœ… é›†æˆæµ‹è¯•é€šè¿‡"
  artifacts:
    reports:
      junit: "**/target/failsafe-reports/TEST-*.xml"
  only:
    - main
    - develop

# å®‰å…¨æ‰«æ
security-scan:
  stage: security
  image: maven:3.9-eclipse-temurin-17-alpine
  <<: *cache_maven
  dependencies:
    - build
  script:
    - echo "ğŸ”’ æ‰§è¡Œå®‰å…¨æ‰«æ..."
    # OWASP ä¾èµ–æ£€æŸ¥
    - mvn org.owasp:dependency-check-maven:check
    # Spring Boot å®‰å…¨æ£€æŸ¥
    - mvn spring-boot:check
    - echo "âœ… å®‰å…¨æ‰«æå®Œæˆ"
  artifacts:
    reports:
      sast: gl-sast-report.json
    paths:
      - target/dependency-check-report.html
    expire_in: 1 week
  allow_failure: true
  only:
    - main
    - develop

# æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
package-gateway:
  stage: package
  image: docker:24.0-dind
  services:
    - docker:24.0-dind
  dependencies:
    - build
    - unit-test
  before_script:
    - echo "$REGISTRY_PASSWORD" | docker login -u "$REGISTRY_USER" --password-stdin $DOCKER_REGISTRY
  script:
    - echo "ğŸ“¦ æ„å»ºç½‘å…³é•œåƒ..."
    - cd gateway
    - docker build -t $DOCKER_REGISTRY/flash-sale-gateway:$IMAGE_TAG .
    - docker tag $DOCKER_REGISTRY/flash-sale-gateway:$IMAGE_TAG $DOCKER_REGISTRY/flash-sale-gateway:$IMAGE_LATEST
    - docker push $DOCKER_REGISTRY/flash-sale-gateway:$IMAGE_TAG
    - docker push $DOCKER_REGISTRY/flash-sale-gateway:$IMAGE_LATEST
    - echo "âœ… ç½‘å…³é•œåƒæ¨é€å®Œæˆ"
  only:
    - main
    - develop

package-order-service:
  stage: package
  image: docker:24.0-dind
  services:
    - docker:24.0-dind
  dependencies:
    - build
    - unit-test
  before_script:
    - echo "$REGISTRY_PASSWORD" | docker login -u "$REGISTRY_USER" --password-stdin $DOCKER_REGISTRY
  script:
    - echo "ğŸ“¦ æ„å»ºè®¢å•æœåŠ¡é•œåƒ..."
    - cd order-service
    - docker build -t $DOCKER_REGISTRY/flash-sale-order-service:$IMAGE_TAG .
    - docker tag $DOCKER_REGISTRY/flash-sale-order-service:$IMAGE_TAG $DOCKER_REGISTRY/flash-sale-order-service:$IMAGE_LATEST
    - docker push $DOCKER_REGISTRY/flash-sale-order-service:$IMAGE_TAG
    - docker push $DOCKER_REGISTRY/flash-sale-order-service:$IMAGE_LATEST
    - echo "âœ… è®¢å•æœåŠ¡é•œåƒæ¨é€å®Œæˆ"
  only:
    - main
    - develop

package-inventory-service:
  stage: package
  image: docker:24.0-dind
  services:
    - docker:24.0-dind
  dependencies:
    - build
    - unit-test
  before_script:
    - echo "$REGISTRY_PASSWORD" | docker login -u "$REGISTRY_USER" --password-stdin $DOCKER_REGISTRY
  script:
    - echo "ğŸ“¦ æ„å»ºåº“å­˜æœåŠ¡é•œåƒ..."
    - cd inventory-service
    - docker build -t $DOCKER_REGISTRY/flash-sale-inventory-service:$IMAGE_TAG .
    - docker tag $DOCKER_REGISTRY/flash-sale-inventory-service:$IMAGE_TAG $DOCKER_REGISTRY/flash-sale-inventory-service:$IMAGE_LATEST
    - docker push $DOCKER_REGISTRY/flash-sale-inventory-service:$IMAGE_TAG
    - docker push $DOCKER_REGISTRY/flash-sale-inventory-service:$IMAGE_LATEST
    - echo "âœ… åº“å­˜æœåŠ¡é•œåƒæ¨é€å®Œæˆ"
  only:
    - main
    - develop

# éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
deploy-staging:
  stage: deploy-staging
  image: bitnami/kubectl:latest
  dependencies:
    - package-gateway
    - package-order-service
    - package-inventory-service
  script:
    - echo "ğŸš€ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."
    - kubectl config use-context staging
    # æ›´æ–°é•œåƒ
    - kubectl set image deployment/gateway gateway=$DOCKER_REGISTRY/flash-sale-gateway:$IMAGE_TAG -n flash-sale-staging
    - kubectl set image deployment/order-service order-service=$DOCKER_REGISTRY/flash-sale-order-service:$IMAGE_TAG -n flash-sale-staging
    - kubectl set image deployment/inventory-service inventory-service=$DOCKER_REGISTRY/flash-sale-inventory-service:$IMAGE_TAG -n flash-sale-staging
    # ç­‰å¾…éƒ¨ç½²å®Œæˆ
    - kubectl rollout status deployment/gateway -n flash-sale-staging --timeout=300s
    - kubectl rollout status deployment/order-service -n flash-sale-staging --timeout=300s
    - kubectl rollout status deployment/inventory-service -n flash-sale-staging --timeout=300s
    - echo "âœ… æµ‹è¯•ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
  environment:
    name: staging
    url: https://flash-sale-staging.example.com
  only:
    - develop

# å†’çƒŸæµ‹è¯•
smoke-test:
  stage: smoke-test
  image: curlimages/curl:latest
  dependencies:
    - deploy-staging
  script:
    - echo "ğŸ’¨ æ‰§è¡Œå†’çƒŸæµ‹è¯•..."
    # å¥åº·æ£€æŸ¥
    - curl -f https://flash-sale-staging.example.com/actuator/health || exit 1
    # ç§’æ€æ¥å£æµ‹è¯•
    - curl -f -X POST https://flash-sale-staging.example.com/api/flash-sale/order/create \
        -H "Content-Type: application/json" \
        -d '{"userId": "test", "activityId": "1", "quantity": 1}' || exit 1
    - echo "âœ… å†’çƒŸæµ‹è¯•é€šè¿‡"
  only:
    - develop

# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆéœ€è¦æ‰‹åŠ¨æ‰¹å‡†ï¼‰
deploy-production:
  stage: deploy-production
  image: bitnami/kubectl:latest
  dependencies:
    - package-gateway
    - package-order-service
    - package-inventory-service
  script:
    - echo "ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
    - kubectl config use-context production
    # é‡‘ä¸é›€éƒ¨ç½²ï¼šå…ˆéƒ¨ç½² 20% æµé‡
    - kubectl patch deployment order-service -n flash-sale -p '{"spec":{"replicas": 10}}'
    - sleep 30
    - kubectl set image deployment/order-service order-service=$DOCKER_REGISTRY/flash-sale-order-service:$IMAGE_TAG -n flash-sale
    # ç­‰å¾…é‡‘ä¸é›€éƒ¨ç½²å®Œæˆ
    - kubectl rollout status deployment/order-service -n flash-sale --timeout=300s
    - echo "â±ï¸  é‡‘ä¸é›€è§‚å¯ŸæœŸï¼ˆ2åˆ†é’Ÿï¼‰..."
    - sleep 120
    # å…¨é‡éƒ¨ç½²
    - kubectl set image deployment/gateway gateway=$DOCKER_REGISTRY/flash-sale-gateway:$IMAGE_TAG -n flash-sale
    - kubectl set image deployment/inventory-service inventory-service=$DOCKER_REGISTRY/flash-sale-inventory-service:$IMAGE_TAG -n flash-sale
    - kubectl rollout status deployment/gateway -n flash-sale --timeout=300s
    - kubectl rollout status deployment/inventory-service -n flash-sale --timeout=300s
    - echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
  environment:
    name: production
    url: https://flash-sale.example.com
  when: manual
  only:
    - main

# å›æ»šä»»åŠ¡
rollback-production:
  stage: deploy-production
  image: bitnami/kubectl:latest
  script:
    - echo "âª å›æ»šç”Ÿäº§ç¯å¢ƒ..."
    - kubectl config use-context production
    - kubectl rollout undo deployment/gateway -n flash-sale
    - kubectl rollout undo deployment/order-service -n flash-sale
    - kubectl rollout undo deployment/inventory-service -n flash-sale
    - echo "âœ… å›æ»šå®Œæˆ"
  environment:
    name: production
    action: stop
  when: manual
  only:
    - main
